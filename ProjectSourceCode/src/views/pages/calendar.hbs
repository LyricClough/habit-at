{{!-- views/pages/calendar.hbs --}}
{{!< layouts/main }}

<div class="min-h-screen bg-background text-foreground px-4 py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold">{{#if user.username}}{{user.username}}'s{{else}}Your{{/if}} Habit Calendar</h1>
    <button id="openModal" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
    + Add Habit
    </button>
  </div>

  <div class="grid grid-cols-7 gap-4">
    {{#each weekdays}}
      <div class="bg-card rounded-2xl shadow p-3 flex flex-col h-[85vh] overflow-y-auto relative">
        <h2 class="text-xl font-semibold mb-3 text-center">{{this}}</h2>

        {{#with ../habitsByDay}}
          {{#each (lookup . @index)}}
            <div class="mb-2">
              <button
                class="block w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow hover:bg-blue-700 transition habit-btn"
                data-habit-id="{{habit_id}}"
                data-name="{{habit_name}}"
                data-description="{{description}}"
                data-weekday="{{weekday}}"
                data-time-slot="{{time_slot}}"
              >
                <span class="block font-semibold">{{habit_name}}</span>
                <span class="block text-sm opacity-90">{{description}}</span>
                <span class="block text-xs mt-1 opacity-75">ðŸ•’ {{time_slot}}:00</span>
              </button>
            </div>
          {{/each}}
        {{/with}}
      </div>
    {{/each}}
  </div>

{{!-- Add Habit Modal --}}
<div id="habitModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
  <!-- BACKDROP -->
  <div class="absolute inset-0 bg-black/50"></div>

  <!-- MODAL CONTENT -->
  <div class="relative z-10 bg-white text-black rounded-2xl shadow-2xl max-w-md w-full p-6">
    <button id="closeModal" class="absolute top-3 right-4 text-2xl text-muted hover:text-destructive transition">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Add New Habit</h2>

    <form id="habitForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Habit Name</label>
        <input name="habitName" type="text" required class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Description</label>
        <input name="habitDescription" type="text" class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Day of the Week</label>
        <select name="habitWeekday" required class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground">
          <option value="">Select a day</option>
          {{#each weekdays}}
            <option value="{{@index}}">{{this}}</option>
          {{/each}}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Time Slot (0â€“23)</label>
        <input name="habitTime" type="number" min="0" max="23" required class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground" />
      </div>
      <div class="pt-4">
        <button type="submit" class="bg-primary text-black px-4 py-2 rounded-lg hover:bg-primary/90 transition w-full">
          Save Habit
        </button>
      </div>
    </form>
  </div>
</div>

<div id="editHabitModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="relative z-10 bg-white text-black rounded-2xl shadow-2xl max-w-md w-full p-6">
    <button id="closeEditModal" class="absolute top-3 right-4 text-2xl text-muted hover:text-destructive transition">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Edit Habit</h2>

    <form id="editHabitForm" class="space-y-4">
      <input type="hidden" name="habitId" />
      <div>
        <label class="block text-sm font-medium mb-1">Habit Name</label>
        <input name="habitName" type="text" required class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Description</label>
        <input name="habitDescription" type="text" class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Day of the Week</label>
        <select name="habitWeekday" required class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground">
          {{#each weekdays}}
            <option value="{{@index}}">{{this}}</option>
          {{/each}}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Time Slot (0â€“23)</label>
        <input name="habitTime" type="number" min="0" max="23" required class="w-full px-3 py-2 border border-border rounded-lg bg-background text-foreground" />
      </div>
      <div class="pt-4 flex justify-between">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
          Save Changes
        </button>
        <button type="button" id="deleteHabit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
          Delete
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Open Add Modal
  document.getElementById('openModal').addEventListener('click', () => {
    document.getElementById('habitModal').classList.remove('hidden');
  });

  document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('habitModal').classList.add('hidden');
  });

  // Open Edit Modal
  document.querySelectorAll('.habit-btn').forEach(button => {
    button.addEventListener('click', () => {
      const modal = document.getElementById('editHabitModal');
      modal.querySelector('[name="habitId"]').value = button.dataset.habitId;
      modal.querySelector('[name="habitName"]').value = button.dataset.name;
      modal.querySelector('[name="habitDescription"]').value = button.dataset.description;
      modal.querySelector('[name="habitWeekday"]').value = button.dataset.weekday;
      modal.querySelector('[name="habitTime"]').value = button.dataset.timeSlot;
      modal.classList.remove('hidden');
    });
  });

  document.getElementById('closeEditModal').addEventListener('click', () => {
    document.getElementById('editHabitModal').classList.add('hidden');
  });

  // Submit Edit
  document.getElementById('editHabitForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = {
      habitId: form.habitId.value,
      habitName: form.habitName.value,
      habitDescription: form.habitDescription.value,
      habitWeekday: form.habitWeekday.value,
      habitTime: form.habitTime.value
    };

    try {
      const res = await fetch('/edit-habit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) window.location.reload();
      else alert('Failed to update habit.');
    } catch (err) {
      console.error(err);
      alert('Error editing habit');
    }
  });

  // Delete Habit
  document.getElementById('deleteHabit').addEventListener('click', async () => {
    const habitId = document.querySelector('#editHabitForm [name="habitId"]').value;
    if (!confirm('Are you sure you want to delete this habit?')) return;

    try {
      const res = await fetch(`/delete-habit/${habitId}`, {
        method: 'DELETE'
      });
      if (res.ok) window.location.reload();
      else alert('Failed to delete habit.');
    } catch (err) {
      console.error(err);
      alert('Error deleting habit');
    }
  });
</script>
